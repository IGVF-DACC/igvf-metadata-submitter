<!DOCTYPE html>
<html>

  <head>
    <base target="_top">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1331.0.min.js"></script>

    <style type="text/css">
      #dropzone {
        text-align: center;
        width: 200px;
        height: 100px;
        margin: 10px;
        padding: 10px;
        border: 4px dashed red;
        border-radius: 10px;
      }

      #boxtitle {
        display: table-cell;
        vertical-align: middle;
        text-align: center;
        color: black;
        font: bold 2em "Arial", sans-serif;
        width: 300px;
        height: 100px;
      }

      body {
        font: 14px "Arial", sans-serif;
      }
    </style>
  </head>

  <body>
    <div id="help-text-dropzone">
      <p>Please DO NOT CLOSE this side bar while uploading files. You can upload files on one sheet at a time.</p>
      <p>Drag the root folder for your data and drop it to the zone below.</p>
      <p>File's relative path (including the root folder) should be defined in column <code>#upload_relpath</code></p>
    </div><br>

    <div id="dropzone">
      <div id="boxtitle">
        Drop root folder here
      </div>
    </div><br>

    <div id="control-panel">
      <button id=btn-init-upload disabled>Initialize uploads for current sheet</button><br><br>
      Sheet name: <label style="color:blue" id="sheet-name"></label><br>
    </div>

    <h3>Upload panel</h3>
    <div id="upload-panel">
    </div>
    <br>
    <button id=btn-update-sheet disabled>Update sheet with upload result</button>

    <script type="text/javascript">
      // constants with the same name as in the server side
      const HEADER_COMMENTED_PROP_UPLOAD_RELPATH = "#upload_relpath";
      const UPLOAD_CREDENTIALS = "upload_credentials";
      const IDENTIFYING_VAL = "identifying_val";

      // store drag-n-dropped folder info
      var fileEntries = [];

      async function getFile(fileEntry) {
        try {
          return new Promise((resolve, reject) => fileEntry.file(resolve, reject));
        } catch (err) {
          console.log(err);
        }
      }

      function getPairedButton(id) {
        const idSuffix = id.match(new RegExp(/^.*\-(.*)/))[1];
        return document.getElementById(`button-${idSuffix}`);
      }

      function getPairedProgressLabel(id) {
        const idSuffix = id.match(new RegExp(/^.*\-(.*)/))[1];
        return document.getElementById(`progress-${idSuffix}`);
      }

      function getPairedStatusLabel(id) {
        const idSuffix = id.match(new RegExp(/^.*\-(.*)/))[1];
        return document.getElementById(`status-${idSuffix}`);
      }

      function reportResultBackToSheet() {        
      }

      async function updateSheetWithUploadResult() {
      }

      async function createUploadItems(inputFromSheet) {
        // parse sheet name and rows
        const sheetName = inputFromSheet[0];
        const rowsString = inputFromSheet[1];

        document.getElementById("sheet-name").innerHTML = sheetName;

        // rowsString is a stringified list of JSON objects (rows on sheet)
        var rows = JSON.parse(rowsString);

        // each upload item (button, progress bar) will be dynalically added upload panel div
        let uploadPanel = document.getElementById("upload-panel");

        // remove all DOM elements in upload panel
        uploadPanel.innerHTML = "";

        // find files matching relpath in user's drag-n-dropped folder
        for(let i=0; i<rows.length; i++) {
          const relpath = rows[i][HEADER_COMMENTED_PROP_UPLOAD_RELPATH];
          const identifyingVal = rows[i][IDENTIFYING_VAL];
          const uploadCredential = rows[i][UPLOAD_CREDENTIALS];

          // trim relpath to ignore leading/trailing slashes in paths
          const trimmedRelpath = relpath.replace(/^\/|\/$/g, "");

          for (let j=0; j<fileEntries.length; j++) {
            const fileEntry = fileEntries[j];
            let foundMatchingfile = false;

            if (!fileEntry) {
              // weird bug, need to ignore undefined element
              continue;
            }
            const trimmedFullPath = fileEntry.fullPath.replace(/^\/|\/$/g, "");

            // if both (on sheet, in drag-n-dropped folder) paths match then make an upload item
            if (trimmedRelpath === trimmedFullPath) {
              foundMatchingfile = true;

              // AWS stuffs
              // authenticate and get S3 client
              var s3Client = new AWS.S3({
                accessKeyId: uploadCredential["access_key"],
                secretAccessKey: uploadCredential["secret_key"],
              });

              // parse bucket, key from s3 URI to define upload params
              const [,,bucket,] = uploadCredential["upload_url"].split("/");
              const key = uploadCredential["upload_url"].split("/").splice(3).join("/");

              // check if file already exists on the bucket
              const fileExistsOnBucket = await s3Client
                .headObject({Bucket: bucket, Key: key})
                .promise()
                .then(
                  () => true,
                  err => {
                    if (err.code === 'NotFound') {
                      return false;
                    }
                    throw err;
                  }
                );
              console.log(fileEntry);
              console.log(fileExistsOnBucket);

              // dynamic creation of upload items
              const idSuffix = window.btoa(fileEntry.fullPath);

              // upload item UI
              var fileInfo = document.createElement("label");              
              fileInfo.innerHTML = `<span style='color: blue;'>${identifyingVal}</span>: ${fileEntry.fullPath}`;

              var br1 = document.createElement("br");

              // label to show "identifying value : file fullpath"
              var progressLabel = document.createElement("label");
              progressLabel.setAttribute("id", "progress-" + idSuffix);
              progressLabel.style["color"] = "red";

              if (fileExistsOnBucket) {
                progressLabel.innerHTML = "100.0%";
              } else {
                progressLabel.innerHTML = "0.0%";
              }

              var nbsp = document.createTextNode("\u00A0");

              var statusLabel = document.createElement("label");
              statusLabel.setAttribute("id", "status-" + idSuffix);
              statusLabel.style["color"] = "darkgray";

              if (fileExistsOnBucket) {
                statusLabel.innerHTML = "File already exists on bucket.";
              } else {
                statusLabel.innerHTML = "Ready for uploading.";
              }

              var br2 = document.createElement("br");

              // button can be either Start or Abort
              var button = document.createElement("button");
              button.setAttribute("id", "button-" + idSuffix);
              button.innerHTML = "Start";

              if (fileExistsOnBucket) {
                button.disabled = true;
              }

              button.onclick = function() {
                const buttonId = this.id;

                this.disabled = true;

                if (this.classList.contains("abort")) {
                  // button is "abort"

                  // abort the upload
                  this.upload.abort();

                  getPairedStatusLabel(buttonId).innerHTML = "Aborted.";
                  this.innerHTML = "Start";

                } else {
                  // button is "start"

                  // get file object and pass it to s3 uploader
                  getFile(fileEntry).then(function(file) {
                    var upload = s3Client.upload(
                        {Bucket: bucket, Key: key, Body: file},
                        function(err, data) {
                          console.log(err);
                          console.log(data);
                        });
                    upload.on("httpUploadProgress", (progress) => {
                        // console.log(id);
                        const progressPct = (100.0*progress.loaded/progress.total).toFixed(1);
                        getPairedProgressLabel(buttonId).innerHTML = `${progressPct}%`;
                      });

                    // save upload object to button DOM
                    // (can't use button's this here)
                    document.getElementById(buttonId).upload = upload;
                  });

                  getPairedStatusLabel(buttonId).innerHTML = "Started uploading.";
                  this.innerHTML = "Abort";
                }

                this.classList.toggle("abort");
                this.disabled = false;
              };

              var br3 = document.createElement("br");
              var br4 = document.createElement("br");

              uploadPanel.appendChild(fileInfo);              
              uploadPanel.appendChild(br1);
              uploadPanel.appendChild(progressLabel);
              uploadPanel.appendChild(nbsp);
              uploadPanel.appendChild(statusLabel);
              uploadPanel.appendChild(br2);
              uploadPanel.appendChild(button);
              uploadPanel.appendChild(br3);
              uploadPanel.appendChild(br4);
              // console.log(fileEntry.fullPath);
            }
          }

          if (!foundMatchingfile) {
            // if there is no matching file in the dropped folder
            // report back to the sheet
            
          }
        }
        document.getElementById("btn-init-upload").innerHTML = "Done reading from sheet.";
        document.getElementById("btn-update-sheet").disabled = false;
      }

      function traverseFileTree(item) {
        if (item.isFile) {
          fileEntries.push(item);
        } else if (item.isDirectory) {
          // Get folder contents
          var dirReader = item.createReader();
          dirReader.readEntries(function(entries) {
            for (var i = 0; i < entries.length; i++) {
              traverseFileTree(entries[i]);
            }
          });
        }
      };

      function onClickInitUpload() {
        let btnInitUpload = document.getElementById("btn-init-upload");
        btnInitUpload.disabled = true;
        btnInitUpload.innerHTML = "Reading from sheet...";
        google.script.run.withSuccessHandler(createUploadItems).initUpload();
      }

      let btnInitUpload = document.getElementById("btn-init-upload");
      let dropzone = document.getElementById("dropzone");

      // buttons
      btnInitUpload.addEventListener("click", onClickInitUpload, false);

      // drag-n-drop
      dropzone.addEventListener("dragover", function(event) {
          event.preventDefault();
      }, false);

      dropzone.addEventListener("drop", function(event) {
        event.preventDefault();
        const data = event.dataTransfer.items;
        for (let i = 0; i < data.length; i++) {
          // recursive directory search
          traverseFileTree(data[i].webkitGetAsEntry());
        }
        dropzone.classList.remove('hover');
        let btnInit = document.getElementById("btn-init-upload");
        btnInit.removeAttribute("disabled");
      }, false);

    </script>
  </body>
</html>
